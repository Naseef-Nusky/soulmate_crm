# Fix Backend Connection for CRM at http://138.68.170.205/

Your CRM is deployed at `http://138.68.170.205/` but can't connect to the backend. Follow these steps:

## Step 1: Fix Backend CORS (On Your Backend Server)

Your backend must allow requests from `http://138.68.170.205`.

### SSH into your backend server and update `.env`:

```bash
cd /path/to/soulmate_backend
nano .env
```

Add or update the `ALLOWED_ORIGINS` line:

```env
ALLOWED_ORIGINS=http://138.68.170.205,https://api.gurulink.app,https://gurulink.app
```

**Important:**
- Include `http://138.68.170.205` (your CRM IP)
- Include your backend domain if different
- Separate multiple origins with commas
- No trailing slashes

Save and exit (Ctrl+X, Y, Enter)

### Restart your backend:

```bash
# If using PM2
pm2 restart all

# If using systemd
systemctl restart your-backend-service

# If running directly
# Stop and restart your backend process
```

## Step 2: Fix CRM API URL (On Your CRM Droplet)

SSH into your CRM droplet:

```bash
ssh root@138.68.170.205
cd /var/www/crm
```

### Check current .env:

```bash
cat .env
```

### Update .env file:

```bash
nano .env
```

Set the backend API URL:

```env
VITE_API_BASE_URL=https://api.gurulink.app
```

**Replace `https://api.gurulink.app` with your actual backend URL:**
- If backend is at `https://api.gurulink.app` â†’ use that
- If backend is at different domain â†’ use that domain
- If backend is on same server â†’ use `http://localhost:4000` or `http://138.68.170.205:4000`

Save and exit (Ctrl+X, Y, Enter)

### Rebuild CRM (CRITICAL):

```bash
cd /var/www/crm
npm run build
```

**IMPORTANT:** You MUST rebuild after changing `.env` - environment variables are only included at build time!

### Restart nginx:

```bash
systemctl restart nginx
```

## Step 3: Verify Backend is Accessible

Test if backend is reachable from CRM droplet:

```bash
# Test backend connection
curl https://api.gurulink.app/api/admin/auth/login \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'
```

If you get a response (even an error), the backend is reachable. If you get connection refused, check:
- Backend is running
- Backend port is open in firewall
- Backend URL is correct

## Step 4: Test from Browser

1. Open `http://138.68.170.205/` in browser
2. Press F12 to open Developer Tools
3. Go to Console tab
4. Try to login
5. Check for errors:
   - **CORS error** â†’ Backend CORS not configured (Step 1)
   - **Network error** â†’ Backend not reachable (check backend URL)
   - **404 error** â†’ Wrong API URL (Step 2)

## Quick Fix Script (Run on CRM Droplet)

```bash
#!/bin/bash
cd /var/www/crm

# Set your backend URL here
BACKEND_URL="https://api.gurulink.app"

echo "Setting VITE_API_BASE_URL=$BACKEND_URL"
echo "VITE_API_BASE_URL=$BACKEND_URL" > .env

echo "Rebuilding application..."
npm run build

echo "Restarting nginx..."
systemctl restart nginx

echo "âœ… Done! Now update backend CORS to allow http://138.68.170.205"
```

## Quick Fix Script (Run on Backend Server)

```bash
#!/bin/bash
cd /path/to/soulmate_backend

# Add CRM IP to allowed origins
if grep -q "ALLOWED_ORIGINS" .env; then
    # Update existing
    sed -i 's|ALLOWED_ORIGINS=.*|ALLOWED_ORIGINS=http://138.68.170.205,https://api.gurulink.app|' .env
else
    # Add new
    echo "ALLOWED_ORIGINS=http://138.68.170.205,https://api.gurulink.app" >> .env
fi

echo "âœ… Updated ALLOWED_ORIGINS"
echo "ðŸ”„ Restarting backend..."

# Restart backend (adjust based on how you run it)
pm2 restart all
# or systemctl restart your-backend-service

echo "âœ… Done!"
```

## Verification Checklist

- [ ] Backend `.env` has `ALLOWED_ORIGINS=http://138.68.170.205,...`
- [ ] Backend restarted after updating `.env`
- [ ] CRM `.env` has correct `VITE_API_BASE_URL=https://api.gurulink.app`
- [ ] CRM rebuilt after updating `.env` (`npm run build`)
- [ ] Nginx restarted after rebuild
- [ ] Backend is running and accessible
- [ ] Tested login from browser

## Still Not Working?

1. **Check browser console (F12)** for specific error
2. **Check backend logs** for CORS errors
3. **Test backend directly:**
   ```bash
   curl -v https://api.gurulink.app/api/admin/auth/login \
     -X POST \
     -H "Content-Type: application/json" \
     -H "Origin: http://138.68.170.205" \
     -d '{"username":"admin","password":"admin123"}'
   ```

4. **Verify backend is running:**
   ```bash
   # On backend server
   ps aux | grep node
   pm2 list
   ```


